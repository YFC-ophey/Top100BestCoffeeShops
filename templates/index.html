<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Top100BestCoffeeShops Preview</title>
    <style>
      :root {
        --brand-gold: #ffd030;
        --brand-orange: #ff7600;
        --brand-dark: #0b0c10;
        --brand-black: #000;
        --brand-surface: #18191e;
        --brand-card: #24252c;
        --brand-pink: #e2acb7;
        --brand-green: #36462e;
        --brand-gray: #888899;
        --brand-white: #f8f8ff;
        --line: rgba(255, 255, 255, 0.09);
      }

      * { box-sizing: border-box; }
      body {
        margin: 0;
        color: var(--brand-white);
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: radial-gradient(circle at 20% -10%, #2a1f1b 0%, transparent 40%),
          radial-gradient(circle at 90% 8%, #2e2118 0%, transparent 38%),
          var(--brand-dark);
      }

      .app-shell {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 12px;
      }

      .shell-topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        border: 1px solid var(--line);
        background: rgba(24, 25, 30, 0.88);
        backdrop-filter: blur(12px);
        border-radius: 16px;
        padding: 10px 12px;
      }

      .brand-wrap {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .brand-icon {
        width: 34px;
        height: 34px;
        border-radius: 10px;
        background: var(--brand-gold);
        color: var(--brand-dark);
        display: grid;
        place-items: center;
        font-size: 1rem;
        font-weight: 900;
      }

      .brand-title {
        margin: 0;
        font-size: 1.05rem;
        font-weight: 800;
        letter-spacing: 0.01em;
      }

      .brand-sub {
        margin: 0;
        color: var(--brand-gray);
        font-size: 0.66rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
      }

      .banner-title {
        margin: 0;
        flex: 1;
        text-align: center;
        font-size: 1.05rem;
        font-weight: 800;
        letter-spacing: 0.02em;
      }

      .category-chip {
        border: 0;
        border-radius: 999px;
        background: transparent;
        color: #cbccd6;
        padding: 6px 12px;
        font-size: 0.74rem;
        font-weight: 700;
        cursor: pointer;
      }

      .category-chip.active {
        background: var(--brand-gold);
        color: var(--brand-dark);
      }

      .topbar-actions {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .view-toggle {
        display: flex;
        align-items: center;
        gap: 3px;
        border: 1px solid var(--line);
        border-radius: 10px;
        background: rgba(0, 0, 0, 0.45);
        padding: 3px;
      }

      .view-btn {
        border: 0;
        border-radius: 8px;
        padding: 6px 10px;
        font-size: 0.72rem;
        font-weight: 700;
        color: #aeb0bc;
        background: transparent;
        cursor: pointer;
      }

      .view-btn.active {
        background: #f4f5fa;
        color: var(--brand-dark);
      }

      .shell-body {
        flex: 1;
        min-height: 0;
        display: grid;
        grid-template-columns: 1fr;
      }

      .workspace-main {
        border: 1px solid var(--line);
        border-radius: 16px;
        background: rgba(24, 25, 30, 0.78);
        backdrop-filter: blur(8px);
        padding: 10px;
        min-height: 0;
      }

      .workspace-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 10px;
      }

      .workspace-head h1 {
        margin: 0;
        font-size: 1.15rem;
        line-height: 1.2;
      }

      .workspace-head p {
        margin: 4px 0 0;
        font-size: 0.82rem;
        color: #9fa3b1;
      }

      .meta-chips {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }

      .chip {
        border: 1px solid var(--line);
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.04);
        padding: 5px 9px;
        font-size: 0.72rem;
      }

      .tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 10px;
      }

      .tab-btn {
        border: 1px solid var(--line);
        border-radius: 9px;
        background: rgba(255, 255, 255, 0.04);
        color: #c7cbd9;
        padding: 7px 11px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
      }

      .tab-btn.active {
        border-color: rgba(255, 208, 48, 0.4);
        background: rgba(255, 208, 48, 0.16);
        color: #ffe8a2;
      }

      .tab-panel {
        display: none;
      }

      .tab-panel.active {
        display: block;
      }

      .overview-panel {
        position: relative;
        border: 1px solid var(--line);
        border-radius: 14px;
        overflow: hidden;
        background: rgba(5, 5, 8, 0.55);
      }

      .overview-stage {
        position: relative;
        min-height: clamp(520px, 70vh, 760px);
      }

      #overview-map {
        position: absolute;
        inset: 0;
      }

      .map-unavailable {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        background: rgba(8, 8, 12, 0.9);
        color: #f2f3fc;
        text-align: center;
        padding: 24px;
        font-size: 0.9rem;
      }

      .map-unavailable.hidden {
        display: none;
      }

      .map-help {
        position: absolute;
        right: 14px;
        bottom: 14px;
        z-index: 5;
        border: 1px solid var(--line);
        border-radius: 12px;
        background: rgba(24, 25, 30, 0.88);
        padding: 8px 10px;
        font-size: 0.72rem;
        color: #dbdeea;
        max-width: 260px;
      }

      .detail-panel {
        position: absolute;
        inset: 10px auto 10px 10px;
        width: min(350px, calc(100% - 20px));
        border: 1px solid var(--line);
        border-radius: 14px;
        overflow: hidden;
        background: rgba(9, 10, 14, 0.92);
        backdrop-filter: blur(12px);
        z-index: 6;
        display: flex;
        flex-direction: column;
      }

      .hero-image {
        position: relative;
        height: 154px;
        overflow: hidden;
      }

      .hero-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        filter: brightness(0.75);
      }

      .hero-overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(180deg, transparent 30%, rgba(0, 0, 0, 0.8) 100%);
      }

      .badge-row {
        position: absolute;
        top: 10px;
        left: 10px;
        display: flex;
        gap: 6px;
      }

      .badge {
        border-radius: 8px;
        padding: 4px 7px;
        font-size: 0.62rem;
        text-transform: uppercase;
        font-weight: 800;
        letter-spacing: 0.05em;
      }

      .badge.rank {
        background: var(--brand-orange);
        color: #0d0d10;
      }

      .badge.type {
        background: rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.15);
      }

      .detail-content {
        display: grid;
        gap: 10px;
        padding: 12px;
        overflow: auto;
      }

      .shop-title {
        margin: 0;
        line-height: 1.1;
        font-size: 1.6rem;
        font-weight: 800;
      }

      .shop-rating {
        margin: 3px 0 0;
        color: #ffd769;
        font-size: 0.73rem;
        font-weight: 700;
      }

      .shop-address {
        margin: 0;
        color: var(--brand-gray);
        font-size: 0.74rem;
      }

      .action-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .btn-primary,
      .btn-secondary {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        border-radius: 8px;
        border: 1px solid var(--line);
        padding: 8px;
        font-size: 0.72rem;
        font-weight: 800;
      }

      .btn-primary {
        grid-column: 1 / -1;
        border-color: rgba(255, 208, 48, 0.45);
        background: var(--brand-gold);
        color: #0f1116;
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.04);
        color: #e8ebf7;
      }

      .detail-section {
        border-top: 1px solid rgba(255, 255, 255, 0.08);
        padding-top: 8px;
      }

      .section-title {
        margin: 0 0 8px;
        color: #d7b84e;
        font-size: 0.63rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-weight: 800;
      }

      .menu-item {
        display: grid;
        grid-template-columns: 42px 1fr auto;
        gap: 8px;
        align-items: center;
        margin-bottom: 8px;
      }

      .menu-thumb {
        width: 42px;
        height: 42px;
        border-radius: 8px;
        object-fit: cover;
      }

      .menu-name {
        margin: 0;
        font-size: 0.74rem;
        font-weight: 700;
      }

      .menu-desc {
        margin: 2px 0 0;
        color: var(--brand-gray);
        font-size: 0.67rem;
        line-height: 1.35;
      }

      .menu-price {
        color: var(--brand-orange);
        font-size: 0.72rem;
        font-weight: 700;
      }

      .details-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .details-card {
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 8px;
        background: rgba(255, 255, 255, 0.04);
      }

      .details-card p {
        margin: 0;
      }

      .details-label {
        color: var(--brand-gray);
        font-size: 0.65rem;
      }

      .details-value {
        margin-top: 2px;
        font-size: 0.79rem;
        font-weight: 700;
      }

      .review-card {
        border: 1px solid var(--line);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.04);
        padding: 9px;
      }

      .review-card p {
        margin: 0;
        font-size: 0.69rem;
        color: #d6dae8;
        line-height: 1.45;
      }

      .book-btn {
        width: 100%;
        border: 0;
        border-radius: 9px;
        padding: 9px;
        background: #f4f5fa;
        color: #0b0c10;
        font-size: 0.74rem;
        font-weight: 800;
      }

      .overview-list {
        padding: 10px;
      }

      .overview-list.is-hidden {
        display: none;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        border: 1px solid var(--line);
        border-radius: 12px;
        overflow: hidden;
        background: rgba(10, 10, 14, 0.75);
      }

      th,
      td {
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        padding: 8px 7px;
        text-align: left;
        font-size: 0.73rem;
      }

      th {
        color: #f1d36a;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-size: 0.66rem;
        background: rgba(255, 255, 255, 0.05);
      }

      .panel {
        border: 1px solid var(--line);
        border-radius: 12px;
        background: rgba(9, 10, 14, 0.65);
        padding: 10px;
      }

      .link-list {
        margin: 0;
        padding-left: 18px;
      }

      .link-list li {
        margin: 6px 0;
      }

      .link-list a {
        color: #ffdca1;
        text-decoration: none;
      }

      .link-list a:hover {
        color: #ffb458;
      }

      .is-hidden {
        display: none !important;
      }

      @media (max-width: 1080px) {
        .banner-title {
          order: 3;
          flex-basis: 100%;
          text-align: left;
        }

        .detail-panel {
          position: static;
          width: 100%;
          border-radius: 0;
          border-left: 0;
          border-right: 0;
          border-top: 1px solid var(--line);
          max-height: 360px;
        }

        .overview-stage {
          padding-top: 0;
          min-height: 650px;
        }
      }

      @media (max-width: 760px) {
        .shell-topbar {
          flex-wrap: wrap;
        }

        .topbar-actions {
          width: 100%;
          justify-content: space-between;
        }

        .workspace-head {
          flex-direction: column;
          align-items: flex-start;
        }
      }

      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation: none !important;
          transition: none !important;
          scroll-behavior: auto !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <header class="shell-topbar">
        <div class="brand-wrap">
          <div class="brand-icon">☕</div>
          <div>
            <p class="brand-title">ROAST.</p>
            <p class="brand-sub">Top100BestCoffeeShops Preview</p>
          </div>
        </div>

        <p class="banner-title">Top 100 Best Coffee Shops 2026</p>

        <div class="topbar-actions">
          <div class="view-toggle">
            <button class="view-btn active" data-overview-view="map">Map</button>
            <button class="view-btn" data-overview-view="list">List</button>
          </div>
          {% if csv_available %}<a class="btn-secondary" href="{{ csv_url }}">CSV</a>{% endif %}
          {% if kml_available %}<a class="btn-secondary" href="{{ kml_url }}">KML</a>{% endif %}
        </div>
      </header>

      <main class="shell-body">
        <section class="workspace-main">
          <div class="workspace-head">
            <div>
              <p>Interactive map of Top 100 World + South America coffee shops.</p>
            </div>
            <div class="meta-chips">
              <span class="chip">Total shops: {{ total_shops }}</span>
              {% for category, count in category_counts.items() %}
              <span class="chip">{{ category }}: {{ count }}</span>
              {% endfor %}
              {% if map_missing_coords_count %}
              <span class="chip">Map skipped: {{ map_missing_coords_count }}</span>
              {% endif %}
            </div>
          </div>

          <div class="tabs" role="tablist" aria-label="Coffee shop views">
            <button class="tab-btn active" data-tab="overview" role="tab" aria-selected="true">Overview</button>
            <button class="tab-btn" data-tab="top100-links" role="tab" aria-selected="false">Top 100 Links</button>
            <button class="tab-btn" data-tab="south-links" role="tab" aria-selected="false">South Links</button>
          </div>

          <section id="overview" class="tab-panel active" role="tabpanel">
            <div class="overview-panel" id="overview-map-region">
              <div class="overview-stage">
                <div id="overview-map" aria-label="Global coffee shops map"></div>
                <div id="map-unavailable" class="map-unavailable hidden"></div>

                <aside class="detail-panel" id="shop-detail-panel">
                  <div class="hero-image">
                    <img
                      id="shop-hero-img"
                      src="https://images.unsplash.com/photo-1554118811-1e0d58224f24?q=80&w=1200&auto=format&fit=crop"
                      alt="Coffee shop interior"
                    />
                    <div class="hero-overlay"></div>
                    <div class="badge-row">
                      <span class="badge rank" id="shop-rank-badge">#1 South America</span>
                      <span class="badge type">Historic Site</span>
                    </div>
                  </div>

                  <div class="detail-content">
                    <div>
                      <h2 class="shop-title" id="shop-name">Choose a marker</h2>
                      <p class="shop-rating" id="shop-rating">Rank and category appear after selection.</p>
                      <p class="shop-address" id="shop-address">Select a coffee shop marker to inspect details.</p>
                    </div>

                    <div class="action-grid">
                      <a class="btn-primary" id="shop-directions" href="#" target="_blank" rel="noopener">Get Directions</a>
                      <a class="btn-secondary" id="shop-website" href="#" target="_blank" rel="noopener">Source Page</a>
                      <a class="btn-secondary" id="shop-map-link" href="#" target="_blank" rel="noopener">Google Maps</a>
                    </div>

                    <section class="detail-section">
                      <p class="section-title">Scraped Details</p>
                      <div class="details-grid">
                        <div class="details-card">
                          <p class="details-label">Category</p>
                          <p class="details-value" id="shop-category">-</p>
                        </div>
                        <div class="details-card">
                          <p class="details-label">City / Country</p>
                          <p class="details-value" id="shop-city-country">-</p>
                        </div>
                        <div class="details-card">
                          <p class="details-label">Coordinates</p>
                          <p class="details-value" id="shop-coordinates">-</p>
                        </div>
                        <div class="details-card">
                          <p class="details-label">Google Place ID</p>
                          <p class="details-value" id="shop-place-id">-</p>
                        </div>
                      </div>
                    </section>
                  </div>
                </aside>

                <div class="map-help">
                  Zoom out for country-level density markers. Zoom in to reveal individual coffee shops.
                </div>
              </div>
            </div>

            <div class="overview-list is-hidden" id="overview-list-region">
              <table>
                <thead>
                  <tr>
                    <th>Rank</th>
                    <th>Name</th>
                    <th>City</th>
                    <th>Country</th>
                    <th>Category</th>
                  </tr>
                </thead>
                <tbody>
                  {% for shop in shops %}
                  <tr>
                    <td>{{ shop.rank }}</td>
                    <td>{{ shop.name }}</td>
                    <td>{{ shop.city }}</td>
                    <td>{{ shop.country }}</td>
                    <td>{{ shop.category }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </section>

          <section id="top100-links" class="tab-panel panel" role="tabpanel">
            <h2>Top 100 Map Links</h2>
            <ol class="link-list">
              {% for item in top_100_links %}
              <li><a href="{{ item.url }}" target="_blank" rel="noopener">{{ item.label }}</a></li>
              {% endfor %}
            </ol>
          </section>

          <section id="south-links" class="tab-panel panel" role="tabpanel">
            <h2>South Map Links</h2>
            <ol class="link-list">
              {% for item in south_links %}
              <li><a href="{{ item.url }}" target="_blank" rel="noopener">{{ item.label }}</a></li>
              {% endfor %}
            </ol>
          </section>
        </section>
      </main>
    </div>

    <script>
      const mapShops = {{ map_shops | tojson }};
      const sidebarShops = {{ sidebar_shops | tojson }};
      const mapCountries = {{ map_country_aggregates | tojson }};
      const googleMapsKey = {{ google_maps_js_api_key | tojson }};
      const mapMissingCoordsCount = {{ map_missing_coords_count }};

      const tabButtons = document.querySelectorAll(".tab-btn");
      const tabPanels = document.querySelectorAll(".tab-panel");
      tabButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const target = button.dataset.tab;
          tabButtons.forEach((item) => {
            const active = item === button;
            item.classList.toggle("active", active);
            item.setAttribute("aria-selected", String(active));
          });
          tabPanels.forEach((panel) => panel.classList.toggle("active", panel.id === target));
        });
      });

      const mapRegion = document.getElementById("overview-map-region");
      const listRegion = document.getElementById("overview-list-region");
      document.querySelectorAll(".view-btn").forEach((button) => {
        button.addEventListener("click", () => {
          const mode = button.dataset.overviewView;
          document.querySelectorAll(".view-btn").forEach((item) => item.classList.toggle("active", item === button));
          if (mode === "list") {
            mapRegion.classList.add("is-hidden");
            listRegion.classList.remove("is-hidden");
          } else {
            mapRegion.classList.remove("is-hidden");
            listRegion.classList.add("is-hidden");
          }
        });
      });

      const markerState = {
        activeCategories: new Set(["Top 100", "South"]),
        countryMarkers: [],
        shopMarkers: [],
        selectedShop: null,
        infoWindow: null,
        map: null,
      };

      function normalizeCategory(category) {
        return category === "South" ? "South" : "Top 100";
      }

      function getVisibleShops() {
        return mapShops.filter((shop) => markerState.activeCategories.has(normalizeCategory(shop.category)));
      }

      function getVisibleSidebarShops() {
        return sidebarShops.filter((shop) => markerState.activeCategories.has(normalizeCategory(shop.category)));
      }

      function showMapMessage(message) {
        const messageBox = document.getElementById("map-unavailable");
        messageBox.textContent = message;
        messageBox.classList.remove("hidden");
      }

      function hideMapMessage() {
        document.getElementById("map-unavailable").classList.add("hidden");
      }

      function colorForCategory(category) {
        return normalizeCategory(category) === "South" ? "#FF7600" : "#FFD030";
      }

      function iconForShop(shop, active) {
        return {
          path: google.maps.SymbolPath.CIRCLE,
          fillColor: active ? "#ff7600" : colorForCategory(shop.category),
          fillOpacity: active ? 1 : 0.95,
          strokeColor: "#ffffff",
          strokeWeight: active ? 2.6 : 1.8,
          scale: active ? 9 : 6,
        };
      }

      function iconForCountry(color, scale) {
        return {
          path: google.maps.SymbolPath.CIRCLE,
          fillColor: color,
          fillOpacity: 0.88,
          strokeColor: "#ffffff",
          strokeWeight: 2,
          scale,
        };
      }

      function toCountryDisplay(shop) {
        return shop.country || "Unknown";
      }

      function shopKey(shop) {
        return `${shop.rank}|${shop.category}|${shop.name}`;
      }

      function escapeHtml(value) {
        return String(value)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      function updateDetailPanel(shop) {
        if (!shop) {
          return;
        }
        document.getElementById("shop-name").textContent = shop.name;
        document.getElementById("shop-rank-badge").textContent = `#${shop.rank} ${shop.category}`;
        document.getElementById("shop-rating").textContent = `Rank #${shop.rank} · ${shop.category}`;

        const location = [shop.address, shop.city, shop.country].filter(Boolean).join(", ");
        document.getElementById("shop-address").textContent = location || "Address unavailable";

        const directions = document.getElementById("shop-directions");
        directions.href = shop.google_maps_url;

        const website = document.getElementById("shop-website");
        website.href = shop.source_url || shop.google_maps_url;
        website.textContent = shop.source_url ? "Source Page" : "Source Unavailable";

        const mapLink = document.getElementById("shop-map-link");
        mapLink.href = shop.google_maps_url;

        const cityCountry = [shop.city, shop.country].filter(Boolean).join(", ");
        document.getElementById("shop-category").textContent = shop.category || "Unknown";
        document.getElementById("shop-city-country").textContent = cityCountry || "Unknown";
        const hasCoords = Number.isFinite(shop.lat) && Number.isFinite(shop.lng);
        document.getElementById("shop-coordinates").textContent = hasCoords
          ? `${Number(shop.lat).toFixed(4)}, ${Number(shop.lng).toFixed(4)}`
          : "Unavailable";
        document.getElementById("shop-place-id").textContent = shop.place_id || "Unavailable";

        const hero = document.getElementById("shop-hero-img");
        hero.alt = `${shop.name} interior`;
      }

      function clearMarkers(markers) {
        markers.forEach((marker) => marker.setMap(null));
        markers.length = 0;
      }

      function openShopInfo(marker, shop) {
        markerState.selectedShop = shop;
        updateDetailPanel(shop);

        const shopName = escapeHtml(shop.name);
        const cityCountry = escapeHtml(`${shop.city ? `${shop.city}, ` : ""}${shop.country || ""}`);
        const category = escapeHtml(shop.category || "");
        markerState.infoWindow.setContent(
          `<div style="min-width:190px;color:#101217;font-family:system-ui,sans-serif">` +
            `<strong>#${shop.rank} ${shopName}</strong><br/>` +
            `<span>${cityCountry}</span><br/>` +
            `<span>${category}</span><br/>` +
            `<a href="${shop.google_maps_url}" target="_blank" rel="noopener">Open in Google Maps</a>` +
          `</div>`
        );
        markerState.infoWindow.open({ map: markerState.map, anchor: marker });
      }

      function renderCountryMarkers() {
        clearMarkers(markerState.countryMarkers);

        const visibleShops = getVisibleShops();
        if (!visibleShops.length) {
          return;
        }

        const counts = new Map();
        visibleShops.forEach((shop) => {
          const key = toCountryDisplay(shop);
          const value = counts.get(key) || { count: 0, sample: shop };
          value.count += 1;
          if (shop.rank < value.sample.rank) {
            value.sample = shop;
          }
          counts.set(key, value);
        });

        const maxCount = Math.max(...Array.from(counts.values()).map((row) => row.count));

        mapCountries.forEach((countryRow) => {
          const match = counts.get(countryRow.country);
          if (!match) {
            return;
          }

          const ratio = match.count / Math.max(1, maxCount);
          const scale = 16 + ratio * 24;

          const marker = new google.maps.Marker({
            position: { lat: countryRow.lat, lng: countryRow.lng },
            map: markerState.map,
            icon: iconForCountry(countryRow.color, scale),
            title: `${countryRow.country} - ${match.count} shops`,
            label: {
              text: String(match.count),
              color: "#111318",
              fontSize: "11px",
              fontWeight: "700",
            },
            zIndex: 4,
          });

          marker.addListener("click", () => {
            markerState.map.setZoom(5);
            markerState.map.panTo(marker.getPosition());
            openShopInfo(marker, match.sample);
          });

          markerState.countryMarkers.push(marker);
        });
      }

      function renderShopMarkers() {
        clearMarkers(markerState.shopMarkers);
        const visibleShops = getVisibleShops();

        visibleShops.forEach((shop) => {
          const active = markerState.selectedShop && shopKey(markerState.selectedShop) === shopKey(shop);
          const marker = new google.maps.Marker({
            position: { lat: shop.lat, lng: shop.lng },
            map: markerState.map,
            icon: iconForShop(shop, active),
            title: `${shop.rank}. ${shop.name}`,
            zIndex: active ? 50 : 8,
          });

          marker.addListener("click", () => {
            markerState.selectedShop = shop;
            renderShopMarkers();
            openShopInfo(marker, shop);
          });

          markerState.shopMarkers.push(marker);
        });
      }

      function refreshMapLayers() {
        if (!markerState.map) {
          return;
        }
        const zoom = markerState.map.getZoom() || 2;

        if (zoom < 4) {
          clearMarkers(markerState.shopMarkers);
          renderCountryMarkers();
        } else {
          clearMarkers(markerState.countryMarkers);
          renderShopMarkers();
        }
      }

      function wireCategoryChips() {
        document.querySelectorAll(".category-chip").forEach((chip) => {
          chip.addEventListener("click", () => {
            const category = chip.dataset.category;
            if (markerState.activeCategories.has(category) && markerState.activeCategories.size === 1) {
              return;
            }
            if (markerState.activeCategories.has(category)) {
              markerState.activeCategories.delete(category);
              chip.classList.remove("active");
            } else {
              markerState.activeCategories.add(category);
              chip.classList.add("active");
            }
            markerState.selectedShop = null;
            refreshMapLayers();

            const visible = getVisibleSidebarShops();
            if (visible.length) {
              updateDetailPanel(visible[0]);
            }
          });
        });
      }

      function initOverviewMap() {
        if (!window.google || !window.google.maps) {
          showMapMessage("Google Maps failed to load. Check your key or network settings.");
          return;
        }

        markerState.map = new google.maps.Map(document.getElementById("overview-map"), {
          center: { lat: 10, lng: 0 },
          zoom: 2,
          disableDefaultUI: false,
          mapTypeControl: false,
          streetViewControl: false,
          fullscreenControl: true,
          styles: [
            { elementType: "geometry", stylers: [{ color: "#202022" }] },
            { elementType: "labels.text.stroke", stylers: [{ color: "#202022" }] },
            { elementType: "labels.text.fill", stylers: [{ color: "#928f86" }] },
            { featureType: "administrative", elementType: "geometry", stylers: [{ color: "#3a3632" }] },
            { featureType: "poi", elementType: "labels.text.fill", stylers: [{ color: "#8a857c" }] },
            { featureType: "road", stylers: [{ visibility: "off" }] },
            { featureType: "water", elementType: "geometry", stylers: [{ color: "#1a1d24" }] },
          ],
        });

        markerState.infoWindow = new google.maps.InfoWindow();
        markerState.selectedShop = getVisibleSidebarShops()[0] || sidebarShops[0] || null;
        updateDetailPanel(markerState.selectedShop);

        markerState.map.addListener("zoom_changed", refreshMapLayers);
        if (!mapShops.length) {
          showMapMessage(
            "No mapped coordinates are available yet. Run owner geocoding first: python src/main.py owner-geocode --api-key $GOOGLE_MAPS_JS_API_KEY"
          );
          document.getElementById("shop-name").textContent = "No geocoded map markers";
          document.getElementById("shop-address").textContent =
            "Map is available, but markers need lat/lng values in data/current_list.json.";
          return;
        }

        hideMapMessage();
        refreshMapLayers();

        if (mapMissingCoordsCount > 0) {
          document.querySelector(".map-help").textContent =
            `${mapMissingCoordsCount} shops were skipped due to missing coordinates.`;
        }
      }

      function loadGoogleMapsScript() {
        if (!googleMapsKey) {
          showMapMessage(
            "Google Maps API key is not configured in environment. Add GOOGLE_MAPS_JS_API_KEY to .env and restart the app."
          );
          return;
        }
        window.initOverviewMap = initOverviewMap;

        const script = document.createElement("script");
        script.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(googleMapsKey)}&callback=initOverviewMap`;
        script.async = true;
        script.defer = true;
        script.onerror = () => {
          showMapMessage("Google Maps failed to load. Please verify API key restrictions.");
        };
        document.head.appendChild(script);
      }

      wireCategoryChips();
      loadGoogleMapsScript();
    </script>
  </body>
</html>
